---
- name: Deploy SSH Keys and Configure System Access
  hosts: ubuntu
  gather_facts: true
  become: true
  vars:
    ssh_public_key_path: "{{ lookup('env', 'HOME') }}/.ssh/id_rsa.pub"

  tasks:
    - name: Check if SSH public key exists
      ansible.builtin.stat:
        path: "{{ ssh_public_key_path }}"
      delegate_to: localhost
      register: ssh_key_check
      run_once: true
      become: false

    - name: Fail if no SSH public key found
      ansible.builtin.fail:
        msg: |
          SSH public key not found at {{ ssh_public_key_path }}.
          Please generate one with: ssh-keygen -t rsa -b 4096
      when: not ssh_key_check.stat.exists

    - name: Read SSH public key content
      ansible.builtin.slurp:
        src: "{{ ssh_public_key_path }}"
      delegate_to: localhost
      register: ssh_public_key_content
      run_once: true
      become: false

    - name: Ensure .ssh directory exists
      ansible.builtin.file:
        path: "/home/{{ ansible_user }}/.ssh"
        state: directory
        mode: '0700'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Deploy SSH public key
      ansible.posix.authorized_key:
        user: "{{ ansible_user }}"
        key: "{{ ssh_public_key_content.content | b64decode | trim }}"
        state: present
        comment: "Deployed via Ansible"

    - name: Configure passwordless sudo
      ansible.builtin.lineinfile:
        path: /etc/sudoers.d/{{ ansible_user }}
        line: "{{ ansible_user }} ALL=(ALL) NOPASSWD:ALL"
        create: true
        mode: '0440'
        validate: 'visudo -cf %s'

    - name: Update package cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Install essential packages
      ansible.builtin.apt:
        name:
          - curl
          - wget
          - vim
          - htop
          - git
        state: present

    - name: Test passwordless sudo
      ansible.builtin.command:
        cmd: sudo whoami
      register: sudo_test
      changed_when: false
      become: false

    - name: Display deployment summary
      ansible.builtin.debug:
        msg:
          - "✅ SSH key deployed successfully to {{ inventory_hostname }}"
          - "✅ Passwordless sudo configured for {{ ansible_user }}"
          - "✅ Essential packages installed"
